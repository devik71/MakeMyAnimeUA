<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ MakeMyAnimeUA ‚Äî –ü–µ—Ä–µ–∫–ª–∞–¥ –°—É–±—Ç–∏—Ç—Ä—ñ–≤</title>
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #1a1a1a;
            --accent-color: #00ff00;
            --text-color: #ff8c00;
            --text-secondary: #ff9933;
            --success-color: #00ff00;
            --warning-color: #ffaa00;
            --error-color: #ff6b6b;
            --border-color: #333;
            --background-dark: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--background-dark) 0%, var(--primary-color) 100%);
            color: var(--text-color);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .step-card {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .step-card:hover {
            border-color: var(--accent-color);
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.3);
        }

        .step-card.active {
            border-color: var(--success-color);
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.4);
        }

        .step-card.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            background: var(--accent-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--accent-color);
            background: rgba(0, 255, 0, 0.1);
        }

        .upload-area.dragover {
            border-color: var(--success-color);
            background: rgba(0, 255, 0, 0.15);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: black;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #00cc00;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            color: black;
            font-weight: 600;
        }

        .btn-success:hover {
            background: #00c49a;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--primary-color);
            color: var(--text-color);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 255, 0, 0.2);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-item:hover {
            border-color: var(--accent-color);
            background: rgba(0, 255, 0, 0.1);
        }

        .radio-item.selected {
            border-color: var(--success-color);
            background: rgba(0, 255, 0, 0.15);
        }

        .radio-item input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .stream-info {
            margin-left: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .progress-container {
            background: var(--primary-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #00ff00, #00cc00);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .progress-text {
            text-align: center;
            font-weight: 500;
        }

        .log-container {
            background: var(--background-dark);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .log-entry.success { color: var(--success-color); }
        .log-entry.error { color: var(--error-color); }
        .log-entry.warning { color: var(--warning-color); }

        .analysis-info {
            background: var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .style-preview {
            background: var(--background-dark);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .subtitle-sample {
            font-size: 1.2rem;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .retro-yellow {
            color: #ffff00;
            text-shadow: 
                -2px -2px 0 #000,
                2px -2px 0 #000,
                -2px 2px 0 #000,
                2px 2px 0 #000,
                -4px -4px 4px #000,
                4px -4px 4px #000,
                -4px 4px 4px #000,
                4px 4px 4px #000;
            font-family: Arial, sans-serif;
        }

        .retro-classic {
            color: #ffff00;
            text-shadow: 
                -3px -3px 0 #000,
                3px -3px 0 #000,
                -3px 3px 0 #000,
                3px 3px 0 #000,
                -6px -6px 6px #000,
                6px -6px 6px #000,
                -6px 6px 6px #000,
                6px 6px 6px #000;
            font-family: Arial, sans-serif;
            font-size: 1.3rem;
        }

        .retro-vintage {
            color: #ffff00;
            text-shadow: 
                -2px -2px 0 #000,
                2px -2px 0 #000,
                -2px 2px 0 #000,
                2px 2px 0 #000,
                -5px -5px 5px #000,
                5px -5px 5px #000,
                -5px 5px 5px #000,
                5px 5px 5px #000;
            font-family: 'Times New Roman', serif;
            font-size: 1.25rem;
        }

        .hidden {
            display: none;
        }

        .translation-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .translation-options {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .step-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ MakeMyAnimeUA</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ–∫–ª–∞–¥ —Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å—É–±—Ç–∏—Ç—Ä—ñ–≤</p>
        </div>

        <!-- –ö—Ä–æ–∫ 1: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ -->
        <div id="step1" class="step-card active">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ</div>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>–û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–µ–æ —Ñ–∞–π–ª –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Å—é–¥–∏</h3>
                <p>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞: MP4, MKV, AVI, MOV</p>
                <input type="file" id="videoFile" accept=".mp4,.mkv,.avi,.mov" style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('videoFile').click()">
                    üìÇ –û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª
                </button>
            </div>
        </div>

        <!-- –ö—Ä–æ–∫ 2: –ê–Ω–∞–ª—ñ–∑ –≤—ñ–¥–µ–æ -->
        <div id="step2" class="step-card disabled">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">–ê–Ω–∞–ª—ñ–∑ –≤—ñ–¥–µ–æ</div>
            </div>
            
            <div id="analysisContent" class="hidden">
                <div class="analysis-info">
                    <h4>üìπ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤—ñ–¥–µ–æ:</h4>
                    <div id="videoInfo"></div>
                </div>

                <div class="form-group">
                    <div class="form-label">üéµ –ê—É–¥—ñ–æ –¥–æ—Ä—ñ–∂–∫–∏:</div>
                    <div id="audioStreams" class="radio-group"></div>
                </div>

                <div class="form-group">
                    <div class="form-label">üìù –î–∂–µ—Ä–µ–ª–æ —Å—É–±—Ç–∏—Ç—Ä—ñ–≤:</div>
                    <div id="subtitleSources" class="radio-group"></div>
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="proceedToConfiguration()">
                        –î–∞–ª—ñ: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–∫–ª–∞–¥—É ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- –ö—Ä–æ–∫ 3: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–∫–ª–∞–¥—É -->
        <div id="step3" class="step-card disabled">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–∫–ª–∞–¥—É</div>
            </div>
            
            <div class="translation-options">
                <div class="form-group">
                    <label class="form-label">üåê –î–≤–∏–∂–æ–∫ –ø–µ—Ä–µ–∫–ª–∞–¥—É:</label>
                    <select id="translationEngine" class="form-control">
                        <option value="helsinki">Helsinki-NLP (–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ, –ª–æ–∫–∞–ª—å–Ω–æ)</option>
                        <option value="deepl">DeepL (–ø–ª–∞—Ç–Ω–æ, –≤–∏—Å–æ–∫–∞ —è–∫—ñ—Å—Ç—å)</option>
                    </select>
                </div>

                <div class="form-group" id="deeplKeyGroup" style="display: none;">
                    <label class="form-label">üîë DeepL API –∫–ª—é—á:</label>
                    <input type="text" id="deeplApiKey" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à API –∫–ª—é—á">
                </div>

                <div class="form-group">
                    <label class="form-label">üó£Ô∏è –ó –º–æ–≤–∏:</label>
                    <select id="sourceLanguage" class="form-control">
                        <option value="ru">–†–æ—Å—ñ–π—Å—å–∫–∞</option>
                        <option value="en">–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞</option>
                        <option value="ja">–Ø–ø–æ–Ω—Å—å–∫–∞</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">üéØ –ù–∞ –º–æ–≤—É:</label>
                    <select id="targetLanguage" class="form-control">
                        <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                        <option value="en">–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞</option>
                        <option value="ru">–†–æ—Å—ñ–π—Å—å–∫–∞</option>
                    </select>
                </div>
            </div>

            <div id="whisperSettings" class="hidden">
                <h4>üß† –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Whisper:</h4>
                <div class="translation-options">
                    <div class="form-group">
                        <label class="form-label">üéØ –ú–æ–¥–µ–ª—å:</label>
                        <select id="whisperModel" class="form-control">
                            <option value="auto">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‚ö° –ü—Ä–æ—Ü–µ—Å–æ—Ä:</label>
                        <select id="deviceType" class="form-control">
                            <option value="auto">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</option>
                            <option value="gpu">GPU</option>
                            <option value="cpu">CPU</option>
                        </select>
                    </div>
                </div>

                <div id="gpuInfo" class="analysis-info">
                    <div id="gpuStatus"></div>
                </div>
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-primary" onclick="proceedToStyleSelection()">
                    –î–∞–ª—ñ: –í–∏–±—ñ—Ä —Å—Ç–∏–ª—é —Å—É–±—Ç–∏—Ç—Ä—ñ–≤ ‚Üí
                </button>
            </div>
        </div>

        <!-- –ö—Ä–æ–∫ 4: –°—Ç–∏–ª—å —Å—É–±—Ç–∏—Ç—Ä—ñ–≤ -->
        <div id="step4" class="step-card disabled">
            <div class="step-header">
                <div class="step-number">4</div>
                <div class="step-title">–°—Ç–∏–ª—å —Å—É–±—Ç–∏—Ç—Ä—ñ–≤</div>
            </div>
            
            <div class="form-group">
                <div class="form-label">üé® –û–±–µ—Ä—ñ—Ç—å —Å—Ç–∏–ª—å:</div>
                <div id="styleOptions" class="radio-group"></div>
            </div>

            <div class="style-preview">
                <h4>üëÅÔ∏è –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥:</h4>
                <div id="stylePreview" class="subtitle-sample retro-yellow">
                    –¶–µ –ø—Ä–∏–∫–ª–∞–¥ —Ç–æ–≥–æ, —è–∫ –±—É–¥—É—Ç—å –≤–∏–≥–ª—è–¥–∞—Ç–∏ —Å—É–±—Ç–∏—Ç—Ä–∏
                </div>
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-primary" onclick="proceedToProcessing()">
                    –î–∞–ª—ñ: –ü–æ—á–∞—Ç–∏ –æ–±—Ä–æ–±–∫—É ‚Üí
                </button>
            </div>
        </div>

        <!-- –ö—Ä–æ–∫ 5: –û–±—Ä–æ–±–∫–∞ -->
        <div id="step5" class="step-card disabled">
            <div class="step-header">
                <div class="step-number">5</div>
                <div class="step-title">–û–±—Ä–æ–±–∫–∞</div>
            </div>
            
            <div class="text-center">
                <button id="startProcessing" class="btn btn-primary btn-lg">
                    üöÄ –ü–æ—á–∞—Ç–∏ –æ–±—Ä–æ–±–∫—É
                </button>
            </div>

            <div id="progressContainer" class="progress-container hidden">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è...</div>
                
                <div class="log-container">
                    <div id="progressLog"></div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–µ—Ä–µ–∫–ª–∞–¥—É -->
            <div id="translationComplete" class="hidden text-center">
                <h3>‚úÖ –ü–µ—Ä–µ–∫–ª–∞–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h3>
                <p>–í–∏ –º–æ–∂–µ—Ç–µ –≤—ñ–¥—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–∫–ª–∞–¥ –∞–±–æ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –±–µ–∑ –∑–º—ñ–Ω</p>
                
                <div style="margin: 20px 0;">
                    <button id="editTranslation" class="btn btn-secondary">
                        ‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–∫–ª–∞–¥
                    </button>
                    <button id="continueWithoutEdit" class="btn btn-success">
                        ‚û°Ô∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –±–µ–∑ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
                    </button>
                </div>
            </div>

            <!-- –§—ñ–Ω–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
            <div id="finalResult" class="hidden text-center">
                <h3>üéâ –ì–æ—Ç–æ–≤–æ!</h3>
                <p>–í–∞—à—ñ —Å—É–±—Ç–∏—Ç—Ä–∏ –≥–æ—Ç–æ–≤—ñ –¥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</p>
                
                <div style="margin: 20px 0;">
                    <button id="downloadSubtitles" class="btn btn-success">
                        üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ ASS —Å—É–±—Ç–∏—Ç—Ä–∏
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
        let currentStep = 1;
        let sessionId = null;
        let analysisData = null;
        let processingInterval = null;

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
            const videoFile = document.getElementById('videoFile');
            const uploadArea = document.getElementById('uploadArea');

            videoFile.addEventListener('change', handleFileSelect);
            
            // Drag & Drop
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);

            // –í–∏–±—ñ—Ä –¥–≤–∏–∂–∫–∞ –ø–µ—Ä–µ–∫–ª–∞–¥—É
            document.getElementById('translationEngine').addEventListener('change', handleEngineChange);

            // –ö–Ω–æ–ø–∫–∏ –æ–±—Ä–æ–±–∫–∏
            document.getElementById('startProcessing').addEventListener('click', startProcessing);
            document.getElementById('editTranslation').addEventListener('click', editTranslation);
            document.getElementById('continueWithoutEdit').addEventListener('click', continueProcessing);
            document.getElementById('downloadSubtitles').addEventListener('click', downloadSubtitles);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                uploadVideo(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                uploadVideo(files[0]);
            }
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function uploadVideo(file) {
            const formData = new FormData();
            formData.append('video', file);

            document.getElementById('uploadArea').innerHTML = `
                <div class="upload-icon">‚è≥</div>
                <h3>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –∞–Ω–∞–ª—ñ–∑...</h3>
                <p>–¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω</p>
            `;

            fetch('/upload_video', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                sessionId = data.session_id;
                analysisData = data;
                
                showAnalysisResults(data);
                showWhisperModels(data.whisper_models);
                showSubtitleStyles(data.subtitle_styles);
                
                activateStep(2);
            })
            .catch(error => {
                document.getElementById('uploadArea').innerHTML = `
                    <div class="upload-icon">‚ùå</div>
                    <h3>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h3>
                    <p>${error.message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        üîÑ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É
                    </button>
                `;
            });
        }

        function showAnalysisResults(data) {
            const analysis = data.analysis;
            
            // –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤—ñ–¥–µ–æ
            const videoInfo = document.getElementById('videoInfo');
            videoInfo.innerHTML = `
                <div class="info-item">
                    <span>üìÅ –§–∞–π–ª:</span>
                    <span>${analysis.video_info.filename}</span>
                </div>
                <div class="info-item">
                    <span>üìè –†–æ–∑–º—ñ—Ä:</span>
                    <span>${(analysis.video_info.size / 1024 / 1024).toFixed(1)} MB</span>
                </div>
            `;

            // –ê—É–¥—ñ–æ –¥–æ—Ä—ñ–∂–∫–∏
            const audioStreams = document.getElementById('audioStreams');
            audioStreams.innerHTML = '';
            
            analysis.audio_streams.forEach((stream, index) => {
                const streamDiv = document.createElement('div');
                streamDiv.className = 'radio-item';
                streamDiv.innerHTML = `
                    <input type="radio" name="audioStream" value="${stream.index}" ${index === 0 ? 'checked' : ''}>
                    <div>
                        <strong>–î–æ—Ä—ñ–∂–∫–∞ ${stream.index}</strong>
                        <div class="stream-info">
                            ${stream.language} ‚Ä¢ ${stream.codec} ‚Ä¢ ${stream.channels} –∫–∞–Ω–∞–ª—ñ–≤
                            ${stream.title ? ` ‚Ä¢ ${stream.title}` : ''}
                        </div>
                    </div>
                `;
                audioStreams.appendChild(streamDiv);
            });

            // –î–∂–µ—Ä–µ–ª–∞ —Å—É–±—Ç–∏—Ç—Ä—ñ–≤
            const subtitleSources = document.getElementById('subtitleSources');
            subtitleSources.innerHTML = '';

            // –í–±—É–¥–æ–≤–∞–Ω—ñ —Å—É–±—Ç–∏—Ç—Ä–∏
            if (analysis.subtitle_streams && analysis.subtitle_streams.length > 0) {
                analysis.subtitle_streams.forEach((stream, index) => {
                    const streamDiv = document.createElement('div');
                    streamDiv.className = 'radio-item';
                    streamDiv.innerHTML = `
                        <input type="radio" name="subtitleSource" value="embedded:${stream.index}" ${index === 0 ? 'checked' : ''}>
                        <div>
                            <strong>–í–±—É–¥–æ–≤–∞–Ω—ñ —Å—É–±—Ç–∏—Ç—Ä–∏ ${stream.index}</strong>
                            <div class="stream-info">
                                ${stream.language} ‚Ä¢ ${stream.codec}
                                ${stream.title ? ` ‚Ä¢ ${stream.title}` : ''}
                            </div>
                        </div>
                    `;
                    subtitleSources.appendChild(streamDiv);
                });
            }

            // –ó–æ–≤–Ω—ñ—à–Ω—ñ —Å—É–±—Ç–∏—Ç—Ä–∏
            if (analysis.external_subtitles && analysis.external_subtitles.length > 0) {
                analysis.external_subtitles.forEach((sub, index) => {
                    const streamDiv = document.createElement('div');
                    streamDiv.className = 'radio-item';
                    streamDiv.innerHTML = `
                        <input type="radio" name="subtitleSource" value="external:${sub.path}">
                        <div>
                            <strong>–ó–æ–≤–Ω—ñ—à–Ω—ñ: ${sub.name}</strong>
                            <div class="stream-info">
                                ${sub.language} ‚Ä¢ ${sub.format} ‚Ä¢ –†–µ–π—Ç–∏–Ω–≥: ${sub.match_score.toFixed(1)}
                            </div>
                        </div>
                    `;
                    subtitleSources.appendChild(streamDiv);
                });
            }

            // –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü—ñ—è –∞—É–¥—ñ–æ
            const transcribeDiv = document.createElement('div');
            transcribeDiv.className = 'radio-item';
            transcribeDiv.innerHTML = `
                <input type="radio" name="subtitleSource" value="transcribe" ${(!analysis.subtitle_streams || analysis.subtitle_streams.length === 0) && (!analysis.external_subtitles || analysis.external_subtitles.length === 0) ? 'checked' : ''}>
                <div>
                    <strong>–¢—Ä–∞–Ω—Å–∫—Ä–∏–±—É–≤–∞—Ç–∏ –∞—É–¥—ñ–æ</strong>
                    <div class="stream-info">
                        –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ Whisper –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—É–±—Ç–∏—Ç—Ä—ñ–≤ –∑ –∞—É–¥—ñ–æ
                    </div>
                </div>
            `;
            subtitleSources.appendChild(transcribeDiv);

            // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è —Ä–∞–¥—ñ–æ –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('input[name="subtitleSource"]').forEach(radio => {
                radio.addEventListener('change', handleSubtitleSourceChange);
            });

            document.getElementById('analysisContent').classList.remove('hidden');
            activateStep(3);
        }

        function handleSubtitleSourceChange() {
            const selectedSource = document.querySelector('input[name="subtitleSource"]:checked').value;
            const whisperSettings = document.getElementById('whisperSettings');
            
            if (selectedSource === 'transcribe') {
                whisperSettings.classList.remove('hidden');
            } else {
                whisperSettings.classList.add('hidden');
            }

            activateStep(4);
        }

        function showWhisperModels(modelData) {
            const whisperModel = document.getElementById('whisperModel');
            whisperModel.innerHTML = '<option value="auto">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä</option>';
            
            modelData.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${model.size}, ${model.quality})`;
                if (model.name === modelData.recommended) {
                    option.textContent += ' - –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è';
                }
                whisperModel.appendChild(option);
            });

            // GPU —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
            const gpuInfo = document.getElementById('gpuInfo');
            const gpuStatus = document.getElementById('gpuStatus');
            
            if (modelData.gpu_available) {
                gpuStatus.innerHTML = `
                    <div class="info-item">
                        <span>üöÄ GPU:</span>
                        <span>–î–æ—Å—Ç—É–ø–Ω–æ (${modelData.gpu_memory} GB)</span>
                    </div>
                    <div class="info-item">
                        <span>üéØ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –º–æ–¥–µ–ª—å:</span>
                        <span>${modelData.recommended}</span>
                    </div>
                `;
            } else {
                gpuStatus.innerHTML = `
                    <div class="info-item">
                        <span>üíª –†–µ–∂–∏–º:</span>
                        <span>CPU (GPU –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ)</span>
                    </div>
                `;
            }
        }

        function showSubtitleStyles(styles) {
            const styleOptions = document.getElementById('styleOptions');
            styleOptions.innerHTML = '';

            const stylesData = [
                { name: 'Dialogue', display: 'Retro Yellow', class: 'retro-yellow', description: '–ö–ª–∞—Å–∏—á–Ω–∏–π –∂–æ–≤—Ç–∏–π –∑ —á–æ—Ä–Ω–æ—é –æ–±–≤–æ–¥–∫–æ—é' },
                { name: 'Retro_Classic', display: 'Retro Classic', class: 'retro-classic', description: '–¢–æ–≤—Å—Ç—ñ—à–∞ –æ–±–≤–æ–¥–∫–∞, –±—ñ–ª—å—à –≤–∏—Ä–∞–∑–Ω–∏–π' },
                { name: 'Retro_Vintage', display: 'Retro Vintage', class: 'retro-vintage', description: 'Times New Roman, –µ–ª–µ–≥–∞–Ω—Ç–Ω–∏–π' }
            ];

            stylesData.forEach((style, index) => {
                const styleDiv = document.createElement('div');
                styleDiv.className = 'radio-item';
                styleDiv.innerHTML = `
                    <input type="radio" name="subtitleStyle" value="${style.name}" ${index === 0 ? 'checked' : ''}>
                    <div>
                        <strong>${style.display}</strong>
                        <div class="stream-info">${style.description}</div>
                    </div>
                `;
                
                styleDiv.addEventListener('click', () => {
                    document.querySelector(`input[name="subtitleStyle"][value="${style.name}"]`).checked = true;
                    updateStylePreview(style.class);
                });
                
                styleOptions.appendChild(styleDiv);
            });

            // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è —Å—Ç–∏–ª—ñ–≤
            document.querySelectorAll('input[name="subtitleStyle"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const selectedStyle = stylesData.find(s => s.name === radio.value);
                    updateStylePreview(selectedStyle.class);
                    activateStep(5);
                });
            });
        }

        function updateStylePreview(className) {
            const preview = document.getElementById('stylePreview');
            preview.className = `subtitle-sample ${className}`;
        }

        function handleEngineChange() {
            const engine = document.getElementById('translationEngine').value;
            const deeplKeyGroup = document.getElementById('deeplKeyGroup');
            
            if (engine === 'deepl') {
                deeplKeyGroup.style.display = 'block';
            } else {
                deeplKeyGroup.style.display = 'none';
            }
        }

        function activateStep(stepNumber) {
            // –î–µ–∞–∫—Ç–∏–≤—É—î–º–æ –≤—Å—ñ –∫—Ä–æ–∫–∏
            document.querySelectorAll('.step-card').forEach(card => {
                card.classList.remove('active');
                card.classList.add('disabled');
            });

            // –ê–∫—Ç–∏–≤—É—î–º–æ –∫—Ä–æ–∫–∏ –¥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≤–∫–ª—é—á–Ω–æ
            for (let i = 1; i <= stepNumber; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('disabled');
                if (i === stepNumber) {
                    step.classList.add('active');
                }
            }

            currentStep = stepNumber;
        }

        function startProcessing() {
            // –ó–±–∏—Ä–∞—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
            const selectedSource = document.querySelector('input[name="subtitleSource"]:checked').value;
            const config = {
                translation_engine: document.getElementById('translationEngine').value,
                source_language: document.getElementById('sourceLanguage').value,
                target_language: document.getElementById('targetLanguage').value,
                subtitle_style: document.querySelector('input[name="subtitleStyle"]:checked').value
            };

            if (config.translation_engine === 'deepl') {
                config.deepl_api_key = document.getElementById('deeplApiKey').value;
            }

            if (selectedSource === 'transcribe') {
                config.source_type = 'transcribe';
                config.whisper_model = document.getElementById('whisperModel').value;
                config.use_gpu = document.getElementById('deviceType').value !== 'cpu';
            } else if (selectedSource.startsWith('embedded:')) {
                config.source_type = 'embedded';
                config.subtitle_stream_index = selectedSource.split(':')[1];
            } else if (selectedSource.startsWith('external:')) {
                config.source_type = 'external';
                config.external_subtitle_path = selectedSource.split(':')[1];
            }

            // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –∑–∞–ø–∏—Ç –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ –æ–±—Ä–æ–±–∫–∏
            fetch('/start_processing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å
                document.getElementById('startProcessing').style.display = 'none';
                document.getElementById('progressContainer').classList.remove('hidden');
                
                // –ó–∞–ø—É—Å–∫–∞—î–º–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—É
                startProgressMonitoring();
            })
            .catch(error => {
                alert(`–ü–æ–º–∏–ª–∫–∞ –ø–æ—á–∞—Ç–∫—É –æ–±—Ä–æ–±–∫–∏: ${error.message}`);
            });
        }

        function startProgressMonitoring() {
            processingInterval = setInterval(() => {
                fetch('/get_progress')
                .then(response => response.json())
                .then(data => {
                    updateProgress(data);
                    
                    if (data.status === 'translation_ready') {
                        clearInterval(processingInterval);
                        showTranslationComplete();
                    } else if (data.status === 'complete') {
                        clearInterval(processingInterval);
                        showFinalResult();
                    } else if (data.status === 'error') {
                        clearInterval(processingInterval);
                        showError(data.progress.message);
                    }
                })
                .catch(error => {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É:', error);
                });
            }, 1000);
        }

        function updateProgress(data) {
            const progress = data.progress;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressLog = document.getElementById('progressLog');

            progressFill.style.width = `${progress.percent}%`;
            progressText.textContent = progress.message;

            // –î–æ–¥–∞—î–º–æ –¥–æ –ª–æ–≥—É
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `${new Date().toLocaleTimeString()}: ${progress.message}`;
            progressLog.appendChild(logEntry);
            progressLog.scrollTop = progressLog.scrollHeight;
        }

        function showTranslationComplete() {
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('translationComplete').classList.remove('hidden');
        }

        function showFinalResult() {
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('translationComplete').classList.add('hidden');
            document.getElementById('finalResult').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('progressContainer').classList.add('hidden');
            alert(`–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏: ${message}`);
        }

        function editTranslation() {
            window.open('/edit_translation', '_blank');
        }

        function continueProcessing() {
            document.getElementById('translationComplete').classList.add('hidden');
            document.getElementById('progressContainer').classList.remove('hidden');
            
            fetch('/continue_processing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                startProgressMonitoring();
            })
            .catch(error => {
                alert(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –æ–±—Ä–æ–±–∫–∏: ${error.message}`);
            });
        }

        function downloadSubtitles() {
            window.location.href = '/download_subtitles';
        }
    </script>
    
    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è JavaScript -->
    <script src="{{ url_for('static', filename='js/pipeline.js') }}?v={{ timestamp }}"></script>
</body>
</html>