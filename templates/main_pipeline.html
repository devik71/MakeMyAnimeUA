<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎬 MakeMyAnimeUA — Переклад Субтитрів</title>
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #1a1a1a;
            --accent-color: #00ff00;
            --text-color: #ff8c00;
            --text-secondary: #ff9933;
            --success-color: #00ff00;
            --warning-color: #ffaa00;
            --error-color: #ff6b6b;
            --border-color: #333;
            --background-dark: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--background-dark) 0%, var(--primary-color) 100%);
            color: var(--text-color);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .step-card {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .step-card:hover {
            border-color: var(--accent-color);
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.3);
        }

        .step-card.active {
            border-color: var(--success-color);
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.4);
        }

        .step-card.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            background: var(--accent-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--accent-color);
            background: rgba(0, 255, 0, 0.1);
        }

        .upload-area.dragover {
            border-color: var(--success-color);
            background: rgba(0, 255, 0, 0.15);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: black;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #00cc00;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            color: black;
            font-weight: 600;
        }

        .btn-success:hover {
            background: #00c49a;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--primary-color);
            color: var(--text-color);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 255, 0, 0.2);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-item:hover {
            border-color: var(--accent-color);
            background: rgba(0, 255, 0, 0.1);
        }

        .radio-item.selected {
            border-color: var(--success-color);
            background: rgba(0, 255, 0, 0.15);
        }

        .radio-item input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .stream-info {
            margin-left: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .progress-container {
            background: var(--primary-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #00ff00, #00cc00);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .progress-text {
            text-align: center;
            font-weight: 500;
        }

        .log-container {
            background: var(--background-dark);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .log-entry.success { color: var(--success-color); }
        .log-entry.error { color: var(--error-color); }
        .log-entry.warning { color: var(--warning-color); }

        .analysis-info {
            background: var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .style-preview {
            background: var(--background-dark);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .subtitle-sample {
            font-size: 1.2rem;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .retro-yellow {
            color: #ffff00;
            text-shadow: 
                -2px -2px 0 #000,
                2px -2px 0 #000,
                -2px 2px 0 #000,
                2px 2px 0 #000,
                -4px -4px 4px #000,
                4px -4px 4px #000,
                -4px 4px 4px #000,
                4px 4px 4px #000;
            font-family: Arial, sans-serif;
        }

        .retro-classic {
            color: #ffff00;
            text-shadow: 
                -3px -3px 0 #000,
                3px -3px 0 #000,
                -3px 3px 0 #000,
                3px 3px 0 #000,
                -6px -6px 6px #000,
                6px -6px 6px #000,
                -6px 6px 6px #000,
                6px 6px 6px #000;
            font-family: Arial, sans-serif;
            font-size: 1.3rem;
        }

        .retro-vintage {
            color: #ffff00;
            text-shadow: 
                -2px -2px 0 #000,
                2px -2px 0 #000,
                -2px 2px 0 #000,
                2px 2px 0 #000,
                -5px -5px 5px #000,
                5px -5px 5px #000,
                -5px 5px 5px #000,
                5px 5px 5px #000;
            font-family: 'Times New Roman', serif;
            font-size: 1.25rem;
        }

        .hidden {
            display: none;
        }

        .translation-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .translation-options {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .step-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 MakeMyAnimeUA</h1>
            <p>Автоматичний переклад та генерація субтитрів</p>
        </div>

        <!-- Крок 1: Завантаження відео -->
        <div id="step1" class="step-card active">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">Завантаження відео</div>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📁</div>
                <h3>Оберіть відео файл або перетягніть сюди</h3>
                <p>Підтримка: MP4, MKV, AVI, MOV</p>
                <input type="file" id="videoFile" accept=".mp4,.mkv,.avi,.mov" style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('videoFile').click()">
                    📂 Обрати файл
                </button>
            </div>
        </div>

        <!-- Крок 2: Аналіз відео -->
        <div id="step2" class="step-card disabled">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">Аналіз відео</div>
            </div>
            
            <div id="analysisContent" class="hidden">
                <div class="analysis-info">
                    <h4>📹 Інформація про відео:</h4>
                    <div id="videoInfo"></div>
                </div>

                <div class="form-group">
                    <div class="form-label">🎵 Аудіо доріжки:</div>
                    <div id="audioStreams" class="radio-group"></div>
                </div>

                <div class="form-group">
                    <div class="form-label">📝 Джерело субтитрів:</div>
                    <div id="subtitleSources" class="radio-group"></div>
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="proceedToConfiguration()">
                        Далі: Налаштування перекладу →
                    </button>
                </div>
            </div>
        </div>

        <!-- Крок 3: Налаштування перекладу -->
        <div id="step3" class="step-card disabled">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">Налаштування перекладу</div>
            </div>
            
            <div class="translation-options">
                <div class="form-group">
                    <label class="form-label">🌐 Движок перекладу:</label>
                    <select id="translationEngine" class="form-control">
                        <option value="helsinki">Helsinki-NLP (безкоштовно, локально)</option>
                        <option value="deepl">DeepL (платно, висока якість)</option>
                    </select>
                </div>

                <div class="form-group" id="deeplKeyGroup" style="display: none;">
                    <label class="form-label">🔑 DeepL API ключ:</label>
                    <input type="text" id="deeplApiKey" class="form-control" placeholder="Введіть ваш API ключ">
                </div>

                <div class="form-group">
                    <label class="form-label">🗣️ З мови:</label>
                    <select id="sourceLanguage" class="form-control">
                        <option value="ru">Російська</option>
                        <option value="en">Англійська</option>
                        <option value="ja">Японська</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">🎯 На мову:</label>
                    <select id="targetLanguage" class="form-control">
                        <option value="uk">Українська</option>
                        <option value="en">Англійська</option>
                        <option value="ru">Російська</option>
                    </select>
                </div>
            </div>

            <div id="whisperSettings" class="hidden">
                <h4>🧠 Налаштування Whisper:</h4>
                <div class="translation-options">
                    <div class="form-group">
                        <label class="form-label">🎯 Модель:</label>
                        <select id="whisperModel" class="form-control">
                            <option value="auto">Автоматичний вибір</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">⚡ Процесор:</label>
                        <select id="deviceType" class="form-control">
                            <option value="auto">Автоматично</option>
                            <option value="gpu">GPU</option>
                            <option value="cpu">CPU</option>
                        </select>
                    </div>
                </div>

                <div id="gpuInfo" class="analysis-info">
                    <div id="gpuStatus"></div>
                </div>
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-primary" onclick="proceedToStyleSelection()">
                    Далі: Вибір стилю субтитрів →
                </button>
            </div>
        </div>

        <!-- Крок 4: Стиль субтитрів -->
        <div id="step4" class="step-card disabled">
            <div class="step-header">
                <div class="step-number">4</div>
                <div class="step-title">Стиль субтитрів</div>
            </div>
            
            <div class="form-group">
                <div class="form-label">🎨 Оберіть стиль:</div>
                <div id="styleOptions" class="radio-group"></div>
            </div>

            <div class="style-preview">
                <h4>👁️ Попередній перегляд:</h4>
                <div id="stylePreview" class="subtitle-sample retro-yellow">
                    Це приклад того, як будуть виглядати субтитри
                </div>
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-primary" onclick="proceedToProcessing()">
                    Далі: Почати обробку →
                </button>
            </div>
        </div>

        <!-- Крок 5: Обробка -->
        <div id="step5" class="step-card disabled">
            <div class="step-header">
                <div class="step-number">5</div>
                <div class="step-title">Обробка</div>
            </div>
            
            <div class="text-center">
                <button id="startProcessing" class="btn btn-primary btn-lg">
                    🚀 Почати обробку
                </button>
            </div>

            <div id="progressContainer" class="progress-container hidden">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">Ініціалізація...</div>
                
                <div class="log-container">
                    <div id="progressLog"></div>
                </div>
            </div>

            <!-- Кнопки після завершення перекладу -->
            <div id="translationComplete" class="hidden text-center">
                <h3>✅ Переклад завершено!</h3>
                <p>Ви можете відредагувати переклад або продовжити без змін</p>
                
                <div style="margin: 20px 0;">
                    <button id="editTranslation" class="btn btn-secondary">
                        ✏️ Редагувати переклад
                    </button>
                    <button id="continueWithoutEdit" class="btn btn-success">
                        ➡️ Продовжити без редагування
                    </button>
                </div>
            </div>

            <!-- Фінальний результат -->
            <div id="finalResult" class="hidden text-center">
                <h3>🎉 Готово!</h3>
                <p>Ваші субтитри готові до завантаження</p>
                
                <div style="margin: 20px 0;">
                    <button id="downloadSubtitles" class="btn btn-success">
                        📥 Завантажити ASS субтитри
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Глобальні змінні
        let currentStep = 1;
        let sessionId = null;
        let analysisData = null;
        let processingInterval = null;

        // Ініціалізація
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            // Завантаження файлу
            const videoFile = document.getElementById('videoFile');
            const uploadArea = document.getElementById('uploadArea');

            videoFile.addEventListener('change', handleFileSelect);
            
            // Drag & Drop
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);

            // Вибір движка перекладу
            document.getElementById('translationEngine').addEventListener('change', handleEngineChange);

            // Кнопки обробки
            document.getElementById('startProcessing').addEventListener('click', startProcessing);
            document.getElementById('editTranslation').addEventListener('click', editTranslation);
            document.getElementById('continueWithoutEdit').addEventListener('click', continueProcessing);
            document.getElementById('downloadSubtitles').addEventListener('click', downloadSubtitles);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                uploadVideo(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                uploadVideo(files[0]);
            }
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function uploadVideo(file) {
            const formData = new FormData();
            formData.append('video', file);

            document.getElementById('uploadArea').innerHTML = `
                <div class="upload-icon">⏳</div>
                <h3>Завантаження та аналіз...</h3>
                <p>Це може зайняти кілька хвилин</p>
            `;

            fetch('/upload_video', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                sessionId = data.session_id;
                analysisData = data;
                
                showAnalysisResults(data);
                showWhisperModels(data.whisper_models);
                showSubtitleStyles(data.subtitle_styles);
                
                activateStep(2);
            })
            .catch(error => {
                document.getElementById('uploadArea').innerHTML = `
                    <div class="upload-icon">❌</div>
                    <h3>Помилка завантаження</h3>
                    <p>${error.message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        🔄 Спробувати знову
                    </button>
                `;
            });
        }

        function showAnalysisResults(data) {
            const analysis = data.analysis;
            
            // Інформація про відео
            const videoInfo = document.getElementById('videoInfo');
            videoInfo.innerHTML = `
                <div class="info-item">
                    <span>📁 Файл:</span>
                    <span>${analysis.video_info.filename}</span>
                </div>
                <div class="info-item">
                    <span>📏 Розмір:</span>
                    <span>${(analysis.video_info.size / 1024 / 1024).toFixed(1)} MB</span>
                </div>
            `;

            // Аудіо доріжки
            const audioStreams = document.getElementById('audioStreams');
            audioStreams.innerHTML = '';
            
            analysis.audio_streams.forEach((stream, index) => {
                const streamDiv = document.createElement('div');
                streamDiv.className = 'radio-item';
                streamDiv.innerHTML = `
                    <input type="radio" name="audioStream" value="${stream.index}" ${index === 0 ? 'checked' : ''}>
                    <div>
                        <strong>Доріжка ${stream.index}</strong>
                        <div class="stream-info">
                            ${stream.language} • ${stream.codec} • ${stream.channels} каналів
                            ${stream.title ? ` • ${stream.title}` : ''}
                        </div>
                    </div>
                `;
                audioStreams.appendChild(streamDiv);
            });

            // Джерела субтитрів
            const subtitleSources = document.getElementById('subtitleSources');
            subtitleSources.innerHTML = '';

            // Вбудовані субтитри
            if (analysis.subtitle_streams && analysis.subtitle_streams.length > 0) {
                analysis.subtitle_streams.forEach((stream, index) => {
                    const streamDiv = document.createElement('div');
                    streamDiv.className = 'radio-item';
                    streamDiv.innerHTML = `
                        <input type="radio" name="subtitleSource" value="embedded:${stream.index}" ${index === 0 ? 'checked' : ''}>
                        <div>
                            <strong>Вбудовані субтитри ${stream.index}</strong>
                            <div class="stream-info">
                                ${stream.language} • ${stream.codec}
                                ${stream.title ? ` • ${stream.title}` : ''}
                            </div>
                        </div>
                    `;
                    subtitleSources.appendChild(streamDiv);
                });
            }

            // Зовнішні субтитри
            if (analysis.external_subtitles && analysis.external_subtitles.length > 0) {
                analysis.external_subtitles.forEach((sub, index) => {
                    const streamDiv = document.createElement('div');
                    streamDiv.className = 'radio-item';
                    streamDiv.innerHTML = `
                        <input type="radio" name="subtitleSource" value="external:${sub.path}">
                        <div>
                            <strong>Зовнішні: ${sub.name}</strong>
                            <div class="stream-info">
                                ${sub.language} • ${sub.format} • Рейтинг: ${sub.match_score.toFixed(1)}
                            </div>
                        </div>
                    `;
                    subtitleSources.appendChild(streamDiv);
                });
            }

            // Транскрибація аудіо
            const transcribeDiv = document.createElement('div');
            transcribeDiv.className = 'radio-item';
            transcribeDiv.innerHTML = `
                <input type="radio" name="subtitleSource" value="transcribe" ${(!analysis.subtitle_streams || analysis.subtitle_streams.length === 0) && (!analysis.external_subtitles || analysis.external_subtitles.length === 0) ? 'checked' : ''}>
                <div>
                    <strong>Транскрибувати аудіо</strong>
                    <div class="stream-info">
                        Використати Whisper для створення субтитрів з аудіо
                    </div>
                </div>
            `;
            subtitleSources.appendChild(transcribeDiv);

            // Обробники подій для радіо кнопок
            document.querySelectorAll('input[name="subtitleSource"]').forEach(radio => {
                radio.addEventListener('change', handleSubtitleSourceChange);
            });

            document.getElementById('analysisContent').classList.remove('hidden');
            activateStep(3);
        }

        function handleSubtitleSourceChange() {
            const selectedSource = document.querySelector('input[name="subtitleSource"]:checked').value;
            const whisperSettings = document.getElementById('whisperSettings');
            
            if (selectedSource === 'transcribe') {
                whisperSettings.classList.remove('hidden');
            } else {
                whisperSettings.classList.add('hidden');
            }

            activateStep(4);
        }

        function showWhisperModels(modelData) {
            const whisperModel = document.getElementById('whisperModel');
            whisperModel.innerHTML = '<option value="auto">Автоматичний вибір</option>';
            
            modelData.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${model.size}, ${model.quality})`;
                if (model.name === modelData.recommended) {
                    option.textContent += ' - Рекомендується';
                }
                whisperModel.appendChild(option);
            });

            // GPU інформація
            const gpuInfo = document.getElementById('gpuInfo');
            const gpuStatus = document.getElementById('gpuStatus');
            
            if (modelData.gpu_available) {
                gpuStatus.innerHTML = `
                    <div class="info-item">
                        <span>🚀 GPU:</span>
                        <span>Доступно (${modelData.gpu_memory} GB)</span>
                    </div>
                    <div class="info-item">
                        <span>🎯 Рекомендована модель:</span>
                        <span>${modelData.recommended}</span>
                    </div>
                `;
            } else {
                gpuStatus.innerHTML = `
                    <div class="info-item">
                        <span>💻 Режим:</span>
                        <span>CPU (GPU недоступне)</span>
                    </div>
                `;
            }
        }

        function showSubtitleStyles(styles) {
            const styleOptions = document.getElementById('styleOptions');
            styleOptions.innerHTML = '';

            const stylesData = [
                { name: 'Dialogue', display: 'Retro Yellow', class: 'retro-yellow', description: 'Класичний жовтий з чорною обводкою' },
                { name: 'Retro_Classic', display: 'Retro Classic', class: 'retro-classic', description: 'Товстіша обводка, більш виразний' },
                { name: 'Retro_Vintage', display: 'Retro Vintage', class: 'retro-vintage', description: 'Times New Roman, елегантний' }
            ];

            stylesData.forEach((style, index) => {
                const styleDiv = document.createElement('div');
                styleDiv.className = 'radio-item';
                styleDiv.innerHTML = `
                    <input type="radio" name="subtitleStyle" value="${style.name}" ${index === 0 ? 'checked' : ''}>
                    <div>
                        <strong>${style.display}</strong>
                        <div class="stream-info">${style.description}</div>
                    </div>
                `;
                
                styleDiv.addEventListener('click', () => {
                    document.querySelector(`input[name="subtitleStyle"][value="${style.name}"]`).checked = true;
                    updateStylePreview(style.class);
                });
                
                styleOptions.appendChild(styleDiv);
            });

            // Обробники подій для стилів
            document.querySelectorAll('input[name="subtitleStyle"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const selectedStyle = stylesData.find(s => s.name === radio.value);
                    updateStylePreview(selectedStyle.class);
                    activateStep(5);
                });
            });
        }

        function updateStylePreview(className) {
            const preview = document.getElementById('stylePreview');
            preview.className = `subtitle-sample ${className}`;
        }

        function handleEngineChange() {
            const engine = document.getElementById('translationEngine').value;
            const deeplKeyGroup = document.getElementById('deeplKeyGroup');
            
            if (engine === 'deepl') {
                deeplKeyGroup.style.display = 'block';
            } else {
                deeplKeyGroup.style.display = 'none';
            }
        }

        function activateStep(stepNumber) {
            // Деактивуємо всі кроки
            document.querySelectorAll('.step-card').forEach(card => {
                card.classList.remove('active');
                card.classList.add('disabled');
            });

            // Активуємо кроки до поточного включно
            for (let i = 1; i <= stepNumber; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('disabled');
                if (i === stepNumber) {
                    step.classList.add('active');
                }
            }

            currentStep = stepNumber;
        }

        function startProcessing() {
            // Збираємо конфігурацію
            const selectedSource = document.querySelector('input[name="subtitleSource"]:checked').value;
            const config = {
                translation_engine: document.getElementById('translationEngine').value,
                source_language: document.getElementById('sourceLanguage').value,
                target_language: document.getElementById('targetLanguage').value,
                subtitle_style: document.querySelector('input[name="subtitleStyle"]:checked').value
            };

            if (config.translation_engine === 'deepl') {
                config.deepl_api_key = document.getElementById('deeplApiKey').value;
            }

            if (selectedSource === 'transcribe') {
                config.source_type = 'transcribe';
                config.whisper_model = document.getElementById('whisperModel').value;
                config.use_gpu = document.getElementById('deviceType').value !== 'cpu';
            } else if (selectedSource.startsWith('embedded:')) {
                config.source_type = 'embedded';
                config.subtitle_stream_index = selectedSource.split(':')[1];
            } else if (selectedSource.startsWith('external:')) {
                config.source_type = 'external';
                config.external_subtitle_path = selectedSource.split(':')[1];
            }

            // Надсилаємо запит на початок обробки
            fetch('/start_processing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Показуємо прогрес
                document.getElementById('startProcessing').style.display = 'none';
                document.getElementById('progressContainer').classList.remove('hidden');
                
                // Запускаємо моніторинг прогресу
                startProgressMonitoring();
            })
            .catch(error => {
                alert(`Помилка початку обробки: ${error.message}`);
            });
        }

        function startProgressMonitoring() {
            processingInterval = setInterval(() => {
                fetch('/get_progress')
                .then(response => response.json())
                .then(data => {
                    updateProgress(data);
                    
                    if (data.status === 'translation_ready') {
                        clearInterval(processingInterval);
                        showTranslationComplete();
                    } else if (data.status === 'complete') {
                        clearInterval(processingInterval);
                        showFinalResult();
                    } else if (data.status === 'error') {
                        clearInterval(processingInterval);
                        showError(data.progress.message);
                    }
                })
                .catch(error => {
                    console.error('Помилка отримання прогресу:', error);
                });
            }, 1000);
        }

        function updateProgress(data) {
            const progress = data.progress;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressLog = document.getElementById('progressLog');

            progressFill.style.width = `${progress.percent}%`;
            progressText.textContent = progress.message;

            // Додаємо до логу
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `${new Date().toLocaleTimeString()}: ${progress.message}`;
            progressLog.appendChild(logEntry);
            progressLog.scrollTop = progressLog.scrollHeight;
        }

        function showTranslationComplete() {
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('translationComplete').classList.remove('hidden');
        }

        function showFinalResult() {
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('translationComplete').classList.add('hidden');
            document.getElementById('finalResult').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('progressContainer').classList.add('hidden');
            alert(`Помилка обробки: ${message}`);
        }

        function editTranslation() {
            window.open('/edit_translation', '_blank');
        }

        function continueProcessing() {
            document.getElementById('translationComplete').classList.add('hidden');
            document.getElementById('progressContainer').classList.remove('hidden');
            
            fetch('/continue_processing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                startProgressMonitoring();
            })
            .catch(error => {
                alert(`Помилка продовження обробки: ${error.message}`);
            });
        }

        function downloadSubtitles() {
            window.location.href = '/download_subtitles';
        }
    </script>
    
    <!-- Підключення JavaScript -->
    <script src="{{ url_for('static', filename='js/pipeline.js') }}?v={{ timestamp }}"></script>
</body>
</html>